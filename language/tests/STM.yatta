let
    stm = STM::new
    balance = STM::var stm 1000f

    withdraw = async \-> let old_balance = (STM::read balance) in STM::write balance (old_balance - 10f)

    max_iterations = 100

    run = \i -> case i of
      x | x >= max_iterations -> STM::read balance
      x -> do
          STM::transaction stm false (\-> withdraw)
          run (i + 1)
          end
        end
in
    run 0
